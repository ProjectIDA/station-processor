#pragma ident "$Id: crc.c,v 1.6 2007/05/18 18:00:57 dechavez Exp $"
/*======================================================================
 * 
 * QDP CRC
 *
 *====================================================================*/
#include "qdp.h"

#define QDP_CRC_TABLE_LEN 256

#ifdef BIG_ENDIAN_HOST
static UINT32 QDP_CRC_TABLE[QDP_CRC_TABLE_LEN] = {
    0x00000000, 0x56070368, 0xac0e06d0, 0xfa0905b8, 0x0e1b0ec8, 0x581c0da0, 
    0xa2150818, 0xf4120b70, 0x1c361d90, 0x4a311ef8, 0xb0381b40, 0xe63f1828, 
    0x122d1358, 0x442a1030, 0xbe231588, 0xe82416e0, 0x386c3b20, 0x6e6b3848, 
    0x94623df0, 0xc2653e98, 0x367735e8, 0x60703680, 0x9a793338, 0xcc7e3050, 
    0x245a26b0, 0x725d25d8, 0x88542060, 0xde532308, 0x2a412878, 0x7c462b10, 
    0x864f2ea8, 0xd0482dc0, 0x70d87640, 0x26df7528, 0xdcd67090, 0x8ad173f8, 
    0x7ec37888, 0x28c47be0, 0xd2cd7e58, 0x84ca7d30, 0x6cee6bd0, 0x3ae968b8, 
    0xc0e06d00, 0x96e76e68, 0x62f56518, 0x34f26670, 0xcefb63c8, 0x98fc60a0, 
    0x48b44d60, 0x1eb34e08, 0xe4ba4bb0, 0xb2bd48d8, 0x46af43a8, 0x10a840c0, 
    0xeaa14578, 0xbca64610, 0x548250f0, 0x02855398, 0xf88c5620, 0xae8b5548, 
    0x5a995e38, 0x0c9e5d50, 0xf69758e8, 0xa0905b80, 0xe1b0ec80, 0xb7b7efe8, 
    0x4dbeea50, 0x1bb9e938, 0xefabe248, 0xb9ace120, 0x43a5e498, 0x15a2e7f0, 
    0xfd86f110, 0xab81f278, 0x5188f7c0, 0x078ff4a8, 0xf39dffd8, 0xa59afcb0, 
    0x5f93f908, 0x0994fa60, 0xd9dcd7a0, 0x8fdbd4c8, 0x75d2d170, 0x23d5d218, 
    0xd7c7d968, 0x81c0da00, 0x7bc9dfb8, 0x2dcedcd0, 0xc5eaca30, 0x93edc958, 
    0x69e4cce0, 0x3fe3cf88, 0xcbf1c4f8, 0x9df6c790, 0x67ffc228, 0x31f8c140, 
    0x91689ac0, 0xc76f99a8, 0x3d669c10, 0x6b619f78, 0x9f739408, 0xc9749760, 
    0x337d92d8, 0x657a91b0, 0x8d5e8750, 0xdb598438, 0x21508180, 0x775782e8, 
    0x83458998, 0xd5428af0, 0x2f4b8f48, 0x794c8c20, 0xa904a1e0, 0xff03a288, 
    0x050aa730, 0x530da458, 0xa71faf28, 0xf118ac40, 0x0b11a9f8, 0x5d16aa90, 
    0xb532bc70, 0xe335bf18, 0x193cbaa0, 0x4f3bb9c8, 0xbb29b2b8, 0xed2eb1d0, 
    0x1727b468, 0x4120b700, 0x9566da68, 0xc361d900, 0x3968dcb8, 0x6f6fdfd0, 
    0x9b7dd4a0, 0xcd7ad7c8, 0x3773d270, 0x6174d118, 0x8950c7f8, 0xdf57c490, 
    0x255ec128, 0x7359c240, 0x874bc930, 0xd14cca58, 0x2b45cfe0, 0x7d42cc88, 
    0xad0ae148, 0xfb0de220, 0x0104e798, 0x5703e4f0, 0xa311ef80, 0xf516ece8, 
    0x0f1fe950, 0x5918ea38, 0xb13cfcd8, 0xe73bffb0, 0x1d32fa08, 0x4b35f960, 
    0xbf27f210, 0xe920f178, 0x1329f4c0, 0x452ef7a8, 0xe5beac28, 0xb3b9af40, 
    0x49b0aaf8, 0x1fb7a990, 0xeba5a2e0, 0xbda2a188, 0x47aba430, 0x11aca758, 
    0xf988b1b8, 0xaf8fb2d0, 0x5586b768, 0x0381b400, 0xf793bf70, 0xa194bc18, 
    0x5b9db9a0, 0x0d9abac8, 0xddd29708, 0x8bd59460, 0x71dc91d8, 0x27db92b0, 
    0xd3c999c0, 0x85ce9aa8, 0x7fc79f10, 0x29c09c78, 0xc1e48a98, 0x97e389f0, 
    0x6dea8c48, 0x3bed8f20, 0xcfff8450, 0x99f88738, 0x63f18280, 0x35f681e8, 
    0x74d636e8, 0x22d13580, 0xd8d83038, 0x8edf3350, 0x7acd3820, 0x2cca3b48, 
    0xd6c33ef0, 0x80c43d98, 0x68e02b78, 0x3ee72810, 0xc4ee2da8, 0x92e92ec0, 
    0x66fb25b0, 0x30fc26d8, 0xcaf52360, 0x9cf22008, 0x4cba0dc8, 0x1abd0ea0, 
    0xe0b40b18, 0xb6b30870, 0x42a10300, 0x14a60068, 0xeeaf05d0, 0xb8a806b8, 
    0x508c1058, 0x068b1330, 0xfc821688, 0xaa8515e0, 0x5e971e90, 0x08901df8, 
    0xf2991840, 0xa49e1b28, 0x040e40a8, 0x520943c0, 0xa8004678, 0xfe074510, 
    0x0a154e60, 0x5c124d08, 0xa61b48b0, 0xf01c4bd8, 0x18385d38, 0x4e3f5e50, 
    0xb4365be8, 0xe2315880, 0x162353f0, 0x40245098, 0xba2d5520, 0xec2a5648, 
    0x3c627b88, 0x6a6578e0, 0x906c7d58, 0xc66b7e30, 0x32797540, 0x647e7628, 
    0x9e777390, 0xc87070f8, 0x20546618, 0x76536570, 0x8c5a60c8, 0xda5d63a0, 
    0x2e4f68d0, 0x78486bb8, 0x82416e00, 0xd4466d68
};
#else
static UINT32 QDP_CRC_TABLE[QDP_CRC_TABLE_LEN] = {
    0x00000000, 0x68030756, 0xd0060eac, 0xb80509fa, 0xc80e1b0e, 0xa00d1c58, 
    0x180815a2, 0x700b12f4, 0x901d361c, 0xf81e314a, 0x401b38b0, 0x28183fe6, 
    0x58132d12, 0x30102a44, 0x881523be, 0xe01624e8, 0x203b6c38, 0x48386b6e, 
    0xf03d6294, 0x983e65c2, 0xe8357736, 0x80367060, 0x3833799a, 0x50307ecc, 
    0xb0265a24, 0xd8255d72, 0x60205488, 0x082353de, 0x7828412a, 0x102b467c, 
    0xa82e4f86, 0xc02d48d0, 0x4076d870, 0x2875df26, 0x9070d6dc, 0xf873d18a, 
    0x8878c37e, 0xe07bc428, 0x587ecdd2, 0x307dca84, 0xd06bee6c, 0xb868e93a, 
    0x006de0c0, 0x686ee796, 0x1865f562, 0x7066f234, 0xc863fbce, 0xa060fc98, 
    0x604db448, 0x084eb31e, 0xb04bbae4, 0xd848bdb2, 0xa843af46, 0xc040a810, 
    0x7845a1ea, 0x1046a6bc, 0xf0508254, 0x98538502, 0x20568cf8, 0x48558bae, 
    0x385e995a, 0x505d9e0c, 0xe85897f6, 0x805b90a0, 0x80ecb0e1, 0xe8efb7b7, 
    0x50eabe4d, 0x38e9b91b, 0x48e2abef, 0x20e1acb9, 0x98e4a543, 0xf0e7a215, 
    0x10f186fd, 0x78f281ab, 0xc0f78851, 0xa8f48f07, 0xd8ff9df3, 0xb0fc9aa5, 
    0x08f9935f, 0x60fa9409, 0xa0d7dcd9, 0xc8d4db8f, 0x70d1d275, 0x18d2d523, 
    0x68d9c7d7, 0x00dac081, 0xb8dfc97b, 0xd0dcce2d, 0x30caeac5, 0x58c9ed93, 
    0xe0cce469, 0x88cfe33f, 0xf8c4f1cb, 0x90c7f69d, 0x28c2ff67, 0x40c1f831, 
    0xc09a6891, 0xa8996fc7, 0x109c663d, 0x789f616b, 0x0894739f, 0x609774c9, 
    0xd8927d33, 0xb0917a65, 0x50875e8d, 0x388459db, 0x80815021, 0xe8825777, 
    0x98894583, 0xf08a42d5, 0x488f4b2f, 0x208c4c79, 0xe0a104a9, 0x88a203ff, 
    0x30a70a05, 0x58a40d53, 0x28af1fa7, 0x40ac18f1, 0xf8a9110b, 0x90aa165d, 
    0x70bc32b5, 0x18bf35e3, 0xa0ba3c19, 0xc8b93b4f, 0xb8b229bb, 0xd0b12eed, 
    0x68b42717, 0x00b72041, 0x68da6695, 0x00d961c3, 0xb8dc6839, 0xd0df6f6f, 
    0xa0d47d9b, 0xc8d77acd, 0x70d27337, 0x18d17461, 0xf8c75089, 0x90c457df, 
    0x28c15e25, 0x40c25973, 0x30c94b87, 0x58ca4cd1, 0xe0cf452b, 0x88cc427d, 
    0x48e10aad, 0x20e20dfb, 0x98e70401, 0xf0e40357, 0x80ef11a3, 0xe8ec16f5, 
    0x50e91f0f, 0x38ea1859, 0xd8fc3cb1, 0xb0ff3be7, 0x08fa321d, 0x60f9354b, 
    0x10f227bf, 0x78f120e9, 0xc0f42913, 0xa8f72e45, 0x28acbee5, 0x40afb9b3, 
    0xf8aab049, 0x90a9b71f, 0xe0a2a5eb, 0x88a1a2bd, 0x30a4ab47, 0x58a7ac11, 
    0xb8b188f9, 0xd0b28faf, 0x68b78655, 0x00b48103, 0x70bf93f7, 0x18bc94a1, 
    0xa0b99d5b, 0xc8ba9a0d, 0x0897d2dd, 0x6094d58b, 0xd891dc71, 0xb092db27, 
    0xc099c9d3, 0xa89ace85, 0x109fc77f, 0x789cc029, 0x988ae4c1, 0xf089e397, 
    0x488cea6d, 0x208fed3b, 0x5084ffcf, 0x3887f899, 0x8082f163, 0xe881f635, 
    0xe836d674, 0x8035d122, 0x3830d8d8, 0x5033df8e, 0x2038cd7a, 0x483bca2c, 
    0xf03ec3d6, 0x983dc480, 0x782be068, 0x1028e73e, 0xa82deec4, 0xc02ee992, 
    0xb025fb66, 0xd826fc30, 0x6023f5ca, 0x0820f29c, 0xc80dba4c, 0xa00ebd1a, 
    0x180bb4e0, 0x7008b3b6, 0x0003a142, 0x6800a614, 0xd005afee, 0xb806a8b8, 
    0x58108c50, 0x30138b06, 0x881682fc, 0xe01585aa, 0x901e975e, 0xf81d9008, 
    0x401899f2, 0x281b9ea4, 0xa8400e04, 0xc0430952, 0x784600a8, 0x104507fe, 
    0x604e150a, 0x084d125c, 0xb0481ba6, 0xd84b1cf0, 0x385d3818, 0x505e3f4e, 
    0xe85b36b4, 0x805831e2, 0xf0532316, 0x98502440, 0x20552dba, 0x48562aec, 
    0x887b623c, 0xe078656a, 0x587d6c90, 0x307e6bc6, 0x40757932, 0x28767e64, 
    0x9073779e, 0xf87070c8, 0x18665420, 0x70655376, 0xc8605a8c, 0xa0635dda, 
    0xd0684f2e, 0xb86b4878, 0x006e4182, 0x686d46d4
};
#endif /* !BIG_ENDIAN_HOST */

UINT32 qdpCRC(UINT8 *buf, int len)
{
UINT32 temp;
union {
    INT8   b[4];
    UINT32 l;
} crc;

    crc.l = 0;

    while (len-- > 0) {
        temp = (crc.b[0] ^ *buf++) & 0xff;
#ifdef BIG_ENDIAN_HOST
        crc.l = (crc.l << 8);
#else
        crc.l = (crc.l >> 8) & (UINT32) 0xffffff;
#endif /* !BIG_ENDIAN_HOST */
        crc.l = crc.l ^ QDP_CRC_TABLE[temp];
    }
#ifdef LTL_ENDIAN_HOST
    utilSwapUINT32(&crc.l, 1);
#endif
    return crc.l;
}

BOOL qdpVerifyCRC(QDP_PKT *pkt)
{
int rawlen;
UINT32 crc;

    rawlen = pkt->hdr.dlen + QDP_CMNHDR_LEN;
    crc = qdpCRC(pkt->raw + 4, rawlen - 4);
    return (crc == pkt->hdr.crc) ? TRUE : FALSE;
}

/* CRC lookup table computed using the following program */

#ifdef INCLUDE_CRC_TABLE_GENERATOR

#include "platform.h"

#define QDP_CRC_POLYNOMIAL 1443300200

int main()
{
int i, bits;
INT32 tdata, accum;
INT32 table[QDP_CRC_TABLE_LEN];

    memset(table, 0xee, sizeof(table));

    for (i = 0; i < QDP_CRC_TABLE_LEN; i++) {
        tdata = ((INT32) i) << 24;
        accum = 0;
        for (bits = 1; bits <= 8; bits++) {
            if ((tdata ^ accum) < 0) {
                accum = (accum << 1) ^ QDP_CRC_POLYNOMIAL;
            } else {
                accum = (accum << 1);
            }
            tdata = tdata << 1;
        }
        table[i] = (INT32) htonl(accum);
    }

    printf("#define QDP_CRC_TABLE_LEN %d\n", QDP_CRC_TABLE_LEN);
    printf("\n");
    printf("static UINT32 QDP_CRC_TABLE[QDP_CRC_TABLE_LEN] = {");
    for (i = 0; i < QDP_CRC_TABLE_LEN; i++) {
        if (i % 6 == 0) printf("\n    ");
        printf("0x%08x", table[i]);
        if (i != QDP_CRC_TABLE_LEN - 1) printf(", ");
    }
    printf("\n};\n");
}

#endif /* INCLUDE_CRC_TABLE_GENERATOR */

/* Revision History
 *
 * $Log: crc.c,v $
 * Revision 1.6  2007/05/18 18:00:57  dechavez
 * initial production release
 *
 */
